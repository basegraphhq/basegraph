#!/bin/bash
# Relay pre-commit hook: build, test, lint before committing

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

section() {
    printf "${CYAN}==>${NC} %s\n" "$1"
}

fail() {
    printf "${RED}✗ %s${NC}\n" "$1" >&2
    exit 1
}

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

if ! command -v make >/dev/null 2>&1; then
    fail "make is required for the api-server pre-commit hook"
fi

changed_api_server_files=$(git diff --cached --name-only --relative | grep '^api-server/' || true)
if [ -z "$changed_api_server_files" ]; then
    printf "${YELLOW}No staged api-server changes detected; skipping api-server checks.${NC}\n"
    exit 0
fi

run_step() {
    local label=$1
    shift
    section "$label"
    if "$@"; then
        printf "${GREEN}✓ %s${NC}\n" "$label"
    else
        fail "$label failed"
    fi
}

run_step "Building api-server (make build)" bash -c 'cd api-server && make build'
run_step "Running api-server tests (make test)" bash -c 'cd api-server && make test'
run_step "Running api-server linters (make lint)" bash -c 'cd api-server && make lint'

printf "${GREEN}All api-server checks passed. Proceeding with commit.${NC}\n"
